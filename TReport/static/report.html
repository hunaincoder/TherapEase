<!DOCTYPE html>
<html>
  <head>
    <title>After-Therapy Report</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }
      .report-section {
        margin-bottom: 30px;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
      }
      .report-section:last-child {
        border-bottom: none;
      }
      .section-title {
        font-weight: bold;
        font-size: 1.2em;
        color: #3498db;
        margin-bottom: 10px;
      }
      .section-content {
        white-space: pre-wrap;
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 4px;
        min-height: 80px;
      }
      .section-content[contenteditable="true"] {
        border: 1px dashed #ccc;
      }
      .back-button {
        display: block;
        text-align: center;
        margin-top: 30px;
        padding: 10px 15px;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        width: 150px;
        margin: 30px auto 0;
      }
      .back-button:hover {
        background-color: #2980b9;
      }
      #saveBtn {
        display: block;
        margin: 20px auto;
        padding: 10px 20px;
        background-color: #2ecc71;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #saveBtn:hover {
        background-color: #27ae60;
      }
    </style>
  </head>
  <body>
    <h1>After-Therapy Session Report</h1>
    <div id="reportContainer"></div>
    <button id="saveBtn">Save Edits</button>
    <a href="/" class="back-button">Back to Upload</a>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const container = document.getElementById("reportContainer");
        const saveBtn = document.getElementById("saveBtn");
        const urlParams = new URLSearchParams(window.location.search);
        const appointmentId = urlParams.get("appointmentId");

        // Function to display status messages
        function showStatus(message, isError = false) {
          container.innerHTML = `
      <div class="${isError ? "error" : "loading"}">
        ${!isError ? '<div class="spinner"></div>' : ""}
        <p>${message}</p>
      </div>
    `;
        }

        showStatus("Loading therapy session report...");
        console.log("Report page loaded for appointment ID:", appointmentId);

        // First check if we have the report in localStorage instead of sessionStorage
        let reportText = localStorage.getItem("finalReport");
        console.log("Found report in localStorage:", !!reportText);

        // If no report is available yet, check if we have diarization results to process
        if (!reportText) {
          const diarizationResult = localStorage.getItem("diarizationResult");
          console.log(
            "Found diarization result in localStorage:",
            !!diarizationResult
          );

          if (diarizationResult) {
            try {
              showStatus("Generating report from session audio...");

              // Generate report from diarization result
              const response = await fetch(
                "http://localhost:8003/generate_report",
                {
                  method: "POST",
                  headers: {
                    "Content-Type": "application/json",
                  },
                  body: JSON.stringify({
                    diarization_result: diarizationResult,
                  }),
                }
              );

              if (!response.ok) {
                throw new Error(`Server responded with ${response.status}`);
              }

              const data = await response.json();
              if (data.report) {
                reportText = data.report;
                localStorage.setItem("finalReport", reportText);
                console.log("Generated and saved new report");
              } else {
                showStatus(
                  "Failed to generate report from session audio.",
                  true
                );
                console.error("No report in API response");
                return;
              }
            } catch (error) {
              console.error("Error generating report:", error);
              showStatus(
                `Error processing session data: ${error.message}`,
                true
              );
              return;
            }
          } else {
            console.error("No diarization data found");
            showStatus(
              "No session data found. Please upload a session first.",
              true
            );
            return;
          }
        }

        // Clear loading indicator
        container.innerHTML = "";

        // Split the report into sections
        const sections = reportText.split("\n\n");
        console.log(`Splitting report into ${sections.length} sections`);

        sections.forEach((section) => {
          if (!section.trim()) return;

          const titleEnd = section.indexOf(":");
          if (titleEnd === -1) return;

          const title = section.substring(0, titleEnd).trim();
          const content = section.substring(titleEnd + 1).trim();

          const sectionDiv = document.createElement("div");
          sectionDiv.className = "report-section";

          const titleDiv = document.createElement("div");
          titleDiv.className = "section-title";
          titleDiv.textContent = title;

          const contentDiv = document.createElement("div");
          contentDiv.className = "section-content";
          contentDiv.contentEditable = "true";
          contentDiv.textContent = content;

          sectionDiv.appendChild(titleDiv);
          sectionDiv.appendChild(contentDiv);
          container.appendChild(sectionDiv);
        });

        saveBtn.addEventListener("click", async () => {
          saveBtn.disabled = true;
          saveBtn.textContent = "Saving...";

          const sections = document.querySelectorAll(".report-section");
          const reportData = {
            appointmentId: appointmentId,
            createdAt: new Date().toISOString(),
          };

          sections.forEach((section) => {
            const key = section
              .querySelector(".section-title")
              .textContent.toLowerCase()
              .replace(/\s+/g, "_"); // e.g. "Primary Concern" â†’ "primary_concern"
            const value = section
              .querySelector(".section-content")
              .textContent.trim();
            reportData[key] = value;
          });

          try {
            const response = await fetch("http://localhost:8003/save_report", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(reportData),
            });

            const data = await response.json();
            if (data.message === "Report saved") {
              alert("Report successfully saved to database!");

              // Clear localStorage
              localStorage.removeItem("finalReport");
              localStorage.removeItem("diarizationResult");
            } else {
              alert(
                "Failed to save the report: " + (data.detail || "Unknown error")
              );
              console.error(data);
            }
          } catch (error) {
            alert("Error saving report: " + error.message);
            console.error(error);
          } finally {
            saveBtn.disabled = false;
            saveBtn.textContent = "Save Edits";
          }
        });
      });
    </script>
  </body>
</html>
